{"version":3,"file":"SimpleAnalyticsWidget-CjyADUOB.js","sources":["../../src/components/SimpleAnalyticsWidget.tsx"],"sourcesContent":["import React, { useState, useEffect } from 'react';\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { LoadingSpinner } from \"@/components/LoadingSpinner\";\r\n\r\n// Performance optimized analytics - updates every hour to reduce server load\r\n\r\ninterface AnalyticsData {\r\n  activeUsers: number;\r\n  todayUsers: number;\r\n  yesterdayUsers: number;\r\n  activeFastingSessions: number;\r\n  activeWalkingSessions: number;\r\n  aiRequestsToday: number;\r\n}\r\n\r\nexport const SimpleAnalyticsWidget = () => {\r\n  const [data, setData] = useState<AnalyticsData>({\r\n    activeUsers: 0,\r\n    todayUsers: 0,\r\n    yesterdayUsers: 0,\r\n    activeFastingSessions: 0,\r\n    activeWalkingSessions: 0,\r\n    aiRequestsToday: 0\r\n  });\r\n  const [loading, setLoading] = useState(true);\r\n  const [gaConfigured, setGaConfigured] = useState(false);\r\n\r\n  const fetchAnalyticsData = async () => {\r\n    try {\r\n      // Check if GA is configured by checking for both service account and property ID\r\n      const { data: gaSettings, error: gaError } = await supabase\r\n        .from('shared_settings')\r\n        .select('setting_value, setting_key')\r\n        .in('setting_key', ['google_analytics_service_account', 'google_analytics_property_id']);\r\n\r\n      const serviceAccountSetting = gaSettings?.find(s => s.setting_key === 'google_analytics_service_account');\r\n      const propertyIdSetting = gaSettings?.find(s => s.setting_key === 'google_analytics_property_id');\r\n      \r\n      const hasGaConfig = !gaError && \r\n        serviceAccountSetting?.setting_value && \r\n        serviceAccountSetting.setting_value !== '{}' &&\r\n        propertyIdSetting?.setting_value &&\r\n        propertyIdSetting.setting_value !== '';\r\n      \r\n      setGaConfigured(!!hasGaConfig);\r\n\r\n      // Fetch active fasting sessions\r\n      const { data: fastingSessions, error: fastingError } = await supabase\r\n        .from('fasting_sessions')\r\n        .select('id')\r\n        .eq('status', 'active');\r\n\r\n      // Fetch active walking sessions\r\n      const { data: walkingSessions, error: walkingError } = await supabase\r\n        .from('walking_sessions')\r\n        .select('id')\r\n        .eq('status', 'active');\r\n\r\n      // Fetch AI requests today\r\n      const { data: aiRequests, error: aiError } = await supabase\r\n        .from('ai_usage_logs')\r\n        .select('id')\r\n        .gte('created_at', new Date().toISOString().split('T')[0]);\r\n\r\n      if (fastingError) console.error('Error fetching fasting sessions:', fastingError);\r\n      if (walkingError) console.error('Error fetching walking sessions:', walkingError);\r\n      if (aiError) console.error('Error fetching AI requests:', aiError);\r\n\r\n      let gaData = { activeUsers: 0, todayUsers: 0, yesterdayUsers: 0 };\r\n\r\n      // If GA is configured, try to fetch real data\r\n      if (hasGaConfig) {\r\n        try {\r\n          const { data: analyticsData, error: analyticsError } = await supabase.functions.invoke('google-analytics-data');\r\n          \r\n          if (!analyticsError && analyticsData && !analyticsData.error) {\r\n            gaData = {\r\n              activeUsers: analyticsData.activeUsers || 0,\r\n              todayUsers: analyticsData.todayUsers || 0,\r\n              yesterdayUsers: analyticsData.yesterdayUsers || 0\r\n            };\r\n          } else {\r\n            console.warn('Failed to fetch Google Analytics data:', analyticsError || analyticsData?.error);\r\n          }\r\n        } catch (analyticsError) {\r\n          console.warn('Error calling Google Analytics function:', analyticsError);\r\n        }\r\n      }\r\n\r\n      setData(prev => ({\r\n        ...prev,\r\n        activeFastingSessions: fastingSessions?.length || 0,\r\n        activeWalkingSessions: walkingSessions?.length || 0,\r\n        aiRequestsToday: aiRequests?.length || 0,\r\n        activeUsers: gaData.activeUsers,\r\n        todayUsers: gaData.todayUsers,\r\n        yesterdayUsers: gaData.yesterdayUsers\r\n      }));\r\n\r\n    } catch (error) {\r\n      console.error('Error fetching analytics data:', error);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const refreshData = () => {\r\n    fetchAnalyticsData();\r\n  };\r\n\r\n  useEffect(() => {\r\n    fetchAnalyticsData();\r\n    // Remove auto-refresh - make it manual only for admin performance\r\n  }, []);\r\n\r\n  if (loading) {\r\n    return (\r\n      <Card className=\"p-6\">\r\n        <div className=\"flex items-center justify-center h-16\">\r\n          <span className=\"text-muted-foreground\">Loading...</span>\r\n        </div>\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  const analyticsMetrics = [\r\n    { \r\n      title: 'Active Users Now',\r\n      items: [\r\n        { label: 'Count', value: data.activeUsers }\r\n      ]\r\n    },\r\n    { \r\n      title: 'Users Today',\r\n      items: [\r\n        { label: 'Count', value: data.todayUsers }\r\n      ]\r\n    },\r\n    { \r\n      title: 'Users Yesterday',\r\n      items: [\r\n        { label: 'Count', value: data.yesterdayUsers }\r\n      ]\r\n    },\r\n    { \r\n      title: 'Active Fasting',\r\n      items: [\r\n        { label: 'Sessions', value: data.activeFastingSessions }\r\n      ]\r\n    },\r\n    { \r\n      title: 'Active Walking',\r\n      items: [\r\n        { label: 'Sessions', value: data.activeWalkingSessions }\r\n      ]\r\n    },\r\n    { \r\n      title: 'AI Requests Today',\r\n      items: [\r\n        { label: 'Count', value: data.aiRequestsToday }\r\n      ]\r\n    }\r\n  ];\r\n\r\n  return (\r\n    <Card>\r\n      <CardHeader>\r\n        <CardTitle className=\"text-lg\">Real-Time Analytics</CardTitle>\r\n      </CardHeader>\r\n      <CardContent>\r\n        {!gaConfigured && (\r\n          <div className=\"mb-4 p-3 bg-yellow-500/10 border border-yellow-500/20 rounded-lg\">\r\n            <p className=\"text-xs text-yellow-700 dark:text-yellow-300\">\r\n              Configure Google Analytics tracking ID in API Configuration to see real user data\r\n            </p>\r\n          </div>\r\n        )}\r\n        <div className=\"grid grid-cols-2 md:grid-cols-2 gap-4\">\r\n          {analyticsMetrics.map((metric, index) => (\r\n            <div key={index} className=\"space-y-3\">\r\n              <h4 className=\"text-xs font-medium text-foreground mb-3 text-center\">\r\n                {metric.title}\r\n              </h4>\r\n              <div className=\"space-y-2\">\r\n                {metric.items.map((item, itemIndex) => (\r\n                  <div key={itemIndex} className=\"flex justify-between items-center p-2 bg-muted/50 rounded-lg\">\r\n                    <span className=\"text-xs text-muted-foreground\">{item.label}</span>\r\n                    <span className=\"text-sm font-semibold text-foreground\">{item.value}</span>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n};"],"names":["SimpleAnalyticsWidget","data","setData","useState","loading","setLoading","gaConfigured","setGaConfigured","fetchAnalyticsData","gaSettings","gaError","supabase","serviceAccountSetting","propertyIdSetting","hasGaConfig","fastingSessions","fastingError","walkingSessions","walkingError","aiRequests","aiError","gaData","analyticsData","analyticsError","prev","error","useEffect","jsx","Card","analyticsMetrics","CardHeader","CardTitle","CardContent","metric","index","jsxs","item","itemIndex"],"mappings":"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"}