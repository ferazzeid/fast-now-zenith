{"version":3,"file":"CancellationTracker-f6hTi_xC.js","sources":["../../src/components/CancellationTracker.tsx"],"sourcesContent":["import React, { useState, useEffect } from 'react';\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { LoadingSpinner } from \"@/components/LoadingSpinner\";\r\n\r\ninterface UserActivityData {\r\n  trialEndingsToday: number;\r\n  trialEndingsMonth: number;\r\n  cancellationsToday: number;\r\n  cancellationsMonth: number;\r\n  upgradestoday: number;\r\n  upgradesMonth: number;\r\n}\r\n\r\nexport const CancellationTracker = () => {\r\n  const [data, setData] = useState<UserActivityData>({\r\n    trialEndingsToday: 0,\r\n    trialEndingsMonth: 0,\r\n    cancellationsToday: 0,\r\n    cancellationsMonth: 0,\r\n    upgradestoday: 0,\r\n    upgradesMonth: 0\r\n  });\r\n  const [loading, setLoading] = useState(true);\r\n\r\n  const fetchUserActivityData = async () => {\r\n    try {\r\n      setLoading(true);\r\n      const today = new Date();\r\n      const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);\r\n      const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());\r\n      const endOfDay = new Date(startOfDay.getTime() + 24 * 60 * 60 * 1000);\r\n\r\n      // Fetch trial endings (free users whose trial ends today/this month)\r\n      const { data: todayTrialEnds } = await supabase\r\n        .from('profiles')\r\n        .select('id')\r\n        .gte('trial_ends_at', startOfDay.toISOString())\r\n        .lt('trial_ends_at', endOfDay.toISOString())\r\n        .eq('subscription_status', 'free');\r\n\r\n      const { data: monthTrialEnds } = await supabase\r\n        .from('profiles')\r\n        .select('id')\r\n        .gte('trial_ends_at', startOfMonth.toISOString())\r\n        .eq('subscription_status', 'free');\r\n\r\n      // Fetch subscription cancellations\r\n      const { data: todayCancellations } = await supabase\r\n        .from('usage_analytics')\r\n        .select('id')\r\n        .eq('event_type', 'subscription_cancelled')\r\n        .gte('created_at', startOfDay.toISOString());\r\n\r\n      const { data: monthCancellations } = await supabase\r\n        .from('usage_analytics')\r\n        .select('id')\r\n        .eq('event_type', 'subscription_cancelled')\r\n        .gte('created_at', startOfMonth.toISOString());\r\n\r\n      // Fetch users who upgraded to paid (trial users who became paid)\r\n      const { data: todayUpgrades } = await supabase\r\n        .from('profiles')\r\n        .select('id')\r\n        .in('subscription_status', ['active', 'trialing'])\r\n        .gte('trial_started_at', startOfDay.toISOString())\r\n        .lt('trial_started_at', endOfDay.toISOString());\r\n\r\n      const { data: monthUpgrades } = await supabase\r\n        .from('profiles')\r\n        .select('id')\r\n        .in('subscription_status', ['active', 'trialing'])\r\n        .gte('trial_started_at', startOfMonth.toISOString());\r\n\r\n      setData({\r\n        trialEndingsToday: todayTrialEnds?.length || 0,\r\n        trialEndingsMonth: monthTrialEnds?.length || 0,\r\n        cancellationsToday: todayCancellations?.length || 0,\r\n        cancellationsMonth: monthCancellations?.length || 0,\r\n        upgradestoday: todayUpgrades?.length || 0,\r\n        upgradesMonth: monthUpgrades?.length || 0\r\n      });\r\n    } catch (error) {\r\n      console.error('Error fetching user activity data:', error);\r\n      setData({\r\n        trialEndingsToday: 0,\r\n        trialEndingsMonth: 0,\r\n        cancellationsToday: 0,\r\n        cancellationsMonth: 0,\r\n        upgradestoday: 0,\r\n        upgradesMonth: 0\r\n      });\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const refreshData = async () => {\r\n    await fetchUserActivityData();\r\n  };\r\n\r\n  useEffect(() => {\r\n    fetchUserActivityData();\r\n  }, []);\r\n\r\n  if (loading) {\r\n    return (\r\n      <Card className=\"p-6\">\r\n        <div className=\"flex items-center justify-center\">\r\n          <LoadingSpinner />\r\n        </div>\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <Card>\r\n      <CardHeader>\r\n        <CardTitle className=\"text-lg flex items-center justify-between\">\r\n          User Activity Tracking\r\n          <Button variant=\"outline\" size=\"sm\" onClick={refreshData}>\r\n            Refresh\r\n          </Button>\r\n        </CardTitle>\r\n      </CardHeader>\r\n      <CardContent>\r\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\r\n          {/* Trial Endings */}\r\n          <div className=\"space-y-3\">\r\n            <h4 className=\"text-sm font-medium text-foreground mb-3 text-center\">\r\n              Trial Endings\r\n            </h4>\r\n            <div className=\"space-y-2\">\r\n              <div className=\"flex justify-between items-center p-2 bg-muted/50 rounded-lg\">\r\n                <span className=\"text-xs text-muted-foreground\">Today</span>\r\n                <span className=\"text-sm font-semibold text-foreground\">{data.trialEndingsToday}</span>\r\n              </div>\r\n              <div className=\"flex justify-between items-center p-2 bg-muted/50 rounded-lg\">\r\n                <span className=\"text-xs text-muted-foreground\">This Month</span>\r\n                <span className=\"text-sm font-semibold text-foreground\">{data.trialEndingsMonth}</span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Cancellations */}\r\n          <div className=\"space-y-3\">\r\n            <h4 className=\"text-sm font-medium text-foreground mb-3 text-center\">\r\n              Cancellations\r\n            </h4>\r\n            <div className=\"space-y-2\">\r\n              <div className=\"flex justify-between items-center p-2 bg-muted/50 rounded-lg\">\r\n                <span className=\"text-xs text-muted-foreground\">Today</span>\r\n                <span className=\"text-sm font-semibold text-foreground\">{data.cancellationsToday}</span>\r\n              </div>\r\n              <div className=\"flex justify-between items-center p-2 bg-muted/50 rounded-lg\">\r\n                <span className=\"text-xs text-muted-foreground\">This Month</span>\r\n                <span className=\"text-sm font-semibold text-foreground\">{data.cancellationsMonth}</span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Upgrades to Paid */}\r\n          <div className=\"space-y-3\">\r\n            <h4 className=\"text-sm font-medium text-foreground mb-3 text-center\">\r\n              Upgrades to Paid\r\n            </h4>\r\n            <div className=\"space-y-2\">\r\n              <div className=\"flex justify-between items-center p-2 bg-muted/50 rounded-lg\">\r\n                <span className=\"text-xs text-muted-foreground\">Today</span>\r\n                <span className=\"text-sm font-semibold text-foreground\">{data.upgradestoday}</span>\r\n              </div>\r\n              <div className=\"flex justify-between items-center p-2 bg-muted/50 rounded-lg\">\r\n                <span className=\"text-xs text-muted-foreground\">This Month</span>\r\n                <span className=\"text-sm font-semibold text-foreground\">{data.upgradesMonth}</span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n};"],"names":["CancellationTracker","data","setData","useState","loading","setLoading","fetchUserActivityData","today","startOfMonth","startOfDay","endOfDay","todayTrialEnds","supabase","monthTrialEnds","todayCancellations","monthCancellations","todayUpgrades","monthUpgrades","error","refreshData","useEffect","jsx","Card","LoadingSpinner","CardHeader","jsxs","CardTitle","Button","CardContent"],"mappings":"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"}