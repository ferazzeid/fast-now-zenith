# üîí CRITICAL CONFIGURATION LOCK
## ‚ö†Ô∏è DO NOT MODIFY WITHOUT EXPLICIT USER PERMISSION ‚ö†Ô∏è

This file documents the **WORKING** configurations that must be preserved to maintain application functionality.

**Last Updated:** 2025-01-09
**Status:** ‚úÖ WORKING - All functions operational

---

## üö® PROTECTED CORS CONFIGURATIONS

### ‚úÖ WORKING CORS SETUP
Both edge functions now use **standardized wildcard CORS** which is PROVEN to work:

```javascript
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type, x-openai-api-key',
  'Access-Control-Allow-Methods': 'POST, OPTIONS',
};
```

### ‚õî NEVER CHANGE TO:
- Origin-based CORS checking
- Complex ALLOWED_ORIGINS logic
- Dynamic origin validation
- Credential-based CORS

**WHY:** These create inconsistent behavior across environments and break functionality.

---

## üîë OPENAI API KEY HIERARCHY (PROTECTED)

### ‚úÖ WORKING PRIORITY ORDER:
1. User's personal API key (if `use_own_api_key` = true)
2. Shared settings in Supabase (`shared_settings.shared_api_key`)
3. Environment variable (`OPENAI_API_KEY`)

### ‚õî NEVER MODIFY:
- The fallback logic order
- The user preference checking
- The API key resolution flow

**WHY:** This hierarchy ensures users can use their own keys while maintaining system functionality.

---

## üõ°Ô∏è FUNCTION-SPECIFIC PROTECTIONS

### `generate-image` Function
- **CORS:** Wildcard only (see above)
- **API Model:** dall-e-2 (proven stable)
- **Response Format:** b64_json (consistent with upload flow)
- **Size:** 512x512 (optimal for motivators)

### `chat-completion` Function  
- **CORS:** Wildcard only (see above)
- **Model:** gpt-4o-mini (cost-effective, reliable)
- **Burst Limit:** 5 requests/10 seconds (prevents abuse)
- **Request Limits:** 15 free, 500 paid (sustainable)

---

## üìã ROLLBACK INSTRUCTIONS

If something breaks, restore these exact configurations:

### For CORS Issues:
```javascript
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type, x-openai-api-key',
  'Access-Control-Allow-Methods': 'POST, OPTIONS',
};
```

### For API Key Issues:
Ensure this exact priority order in both functions:
1. User key (if enabled) ‚Üí 2. Shared settings ‚Üí 3. Environment variable

---

## üîí PROTECTED FILES LIST

These files contain critical configurations and should NOT be modified without user approval:

1. `supabase/functions/generate-image/index.ts` - Image generation with CORS
2. `supabase/functions/chat-completion/index.ts` - Chat completion with CORS  
3. `supabase/config.toml` - Function JWT settings
4. `src/integrations/supabase/client.ts` - Supabase connection
5. `src/hooks/useDynamicFavicon.tsx` - Favicon handling

---

## ‚ö†Ô∏è CHANGE PROTOCOL

**BEFORE making ANY changes to protected configurations:**

1. ‚úã STOP - Check if this file marks it as protected
2. ü§î ASK - Get explicit user permission  
3. üìù DOCUMENT - Update this file with changes
4. ‚úÖ TEST - Verify functionality still works
5. üîÑ ROLLBACK - Have restore plan ready

**Remember: Working configurations are more valuable than "perfect" configurations.**

---

*Generated by protective measures implementation - 2025-01-09*